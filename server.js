// Generated by CoffeeScript 1.3.3
(function() {
  var actions, app, checkDecisionPlugins, config, redis, rtg, saveParameters, saveRedisData,
    _this = this;

  this.express = require('express');

  this.twilio = require('twilio');

  config = require('./config');

  if (process.env.REDISTOGO_URL) {
    rtg = require("url").parse(process.env.REDISTOGO_URL);
    redis = require("redis").createClient(rtg.port, rtg.hostname);
    redis.auth(rtg.auth.split(":")[1]);
  } else {
    redis = require("redis").createClient();
  }

  redis.on("error", function(err) {
    return console.log("Error " + err);
  });

  redis.on("connect", function() {
    redis.incr('started');
    return redis.get('started', function(err, response) {
      if (!err) {
        return console.log('Started', response, 'times');
      }
    });
  });

  app = this.express();

  app.use(this.express.bodyParser());

  app.get('/', function(request, response) {
    return response.send('Hello World');
  });

  saveParameters = function(request) {};

  checkDecisionPlugins = function(callSid, request, response) {
    var decisionPlugin, i, _i, _len, _ref;
    decisionPlugin = {};
    _ref = config.plugins.decisions;
    for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
      decisionPlugin = _ref[i];
      decisionPlugin = decisionPlugin.run(callSid, request, response);
      if (decisionPlugin.outcome = true) {
        break;
      }
    }
    return actions(callSid, decisionPlugin, request, response);
  };

  actions = function(callSid, decision, request, response) {
    var actionPlugin, _i, _len, _ref;
    console.log('actions hit');
    response.type("text/xml");
    _ref = config.plugins.actions;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      actionPlugin = _ref[_i];
      if (decision.outcome === true && actionPlugin.runOnTrue === true) {
        actionPlugin.run(callSid, request, response);
      } else if (decision.outcome === false && actionPlugin.runOnFalse === true) {
        actionPlugin.run(callSid, request, response);
      }
    }
    return response.end();
  };

  saveRedisData = function(hash, data) {};

  app.post("/respondToVoiceCall", function(request, response) {
    var callSid;
    callSid = request.body.CallSid;
    console.log('Call -', callSid);
    saveParameters(request);
    if (_this.twilio.validateExpressRequest(request, '20f65a9da68ec4630c9c43d19baef94e')) {
      return checkDecisionPlugins(callSid, request, response);
    } else {
      return response.send("you are not twilio.  Buzz off.");
    }
  });

  app.listen(process.env.PORT || 5000);

}).call(this);
